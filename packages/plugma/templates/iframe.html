<iframe id="myIframe" name="plugma-inner-iframe" style="width: 100%; height: 100vh; border: none;"></iframe>

<script>
	function isRunningInFigmaUI() {
		// Check if the window is running in an iframe
		const isIframe = window.parent !== window;

		// Check for Figma-specific markers in the user agent
		const isFigmaUserAgent = navigator.userAgent.includes("Figma");

		return isIframe && isFigmaUserAgent;
	}

	// Get the iframe element
	let iframe = document.getElementById('myIframe');

	// Create a basic HTML structure and include the scripts
	let iframeContent = `
		<div id="app">This is inside the iframe!</div>
		<script type="module" src="/node_modules/plugma/frameworks/common/ui/catchFigmaStyles.ts"><\/script>
		<script type="module" src="/node_modules/plugma/frameworks/common/ui/startWebSocketServer.ts"><\/script>
		<script type="module" id="entry" src="<%= input %>"><\/script>
	`;

	// Write the content to the iframe's document
	let doc = iframe.contentWindow.document;
	doc.open();
	doc.write(iframeContent);
	doc.close();

	// Any messages sent from UI need to pass up to the parent (main code), but not if running headless in browser
	if (isRunningInFigmaUI()) {
		console.log("--- origin1", window.name)
		console.log("--- origin2", iframe.contentWindow.name)
		window.addEventListener('message', (event) => {
			console.log(event)

			// Forward up to parent if it comes from "plugma-inner-iframe"
			if (event.origin !== "https://www.figma.com") {
				console.log("post upwards")
				// parent.postMessage(
				// 	{
				// 		pluginMessage: event.data.pluginMessage,
				// 		pluginId: event.data.pluginId,
				// 	},
				// 	"*",
				// );
				parent.postMessage(event.data, "*")
			}


			// Forward down to inner iframe if it comes from "Inner Plugin Iframe"
			if (event.origin === "https://www.figma.com") {
				console.log("post downwards")
				// iframe.contentWindow.postMessage(
				// 	{
				// 		pluginMessage: event.data.pluginMessage,
				// 		pluginId: event.data.pluginId,
				// 	},
				// 	"*",
				// );
				iframe.contentWindow.postMessage(event.data, "*")
			}

		});


	}
</script>